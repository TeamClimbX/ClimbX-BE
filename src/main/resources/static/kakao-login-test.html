<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta content="width=device-width, initial-scale=1.0" name="viewport">
  <title>🧪 카카오 로그인 테스트 - ClimbX</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .container {
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
      padding: 2rem;
      max-width: 500px;
      width: 90%;
    }

    .header {
      text-align: center;
      margin-bottom: 2rem;
    }

    .header h1 {
      color: #333;
      margin-bottom: 0.5rem;
      font-size: 1.8rem;
    }

    .header p {
      color: #666;
      font-size: 0.9rem;
    }

    .section {
      margin-bottom: 2rem;
      padding: 1.5rem;
      background: #f8f9fa;
      border-radius: 12px;
      border: 1px solid #e9ecef;
    }

    .section h3 {
      color: #495057;
      margin-bottom: 1rem;
      font-size: 1.1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .form-group {
      margin-bottom: 1rem;
    }

    label {
      display: block;
      margin-bottom: 0.5rem;
      color: #495057;
      font-weight: 500;
      font-size: 0.9rem;
    }

    input[type="text"] {
      width: 100%;
      padding: 0.75rem;
      border: 2px solid #e9ecef;
      border-radius: 8px;
      font-size: 1rem;
      transition: border-color 0.2s;
    }

    input[type="text"]:focus {
      outline: none;
      border-color: #667eea;
    }

    .btn {
      background: linear-gradient(45deg, #667eea, #764ba2);
      color: white;
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 500;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
      margin: 0.25rem;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    .btn-secondary {
      background: linear-gradient(45deg, #6c757d, #495057);
    }

    .btn-secondary:hover {
      box-shadow: 0 4px 12px rgba(108, 117, 125, 0.4);
    }

    .btn-kakao {
      background: linear-gradient(45deg, #fee500, #ffcd00);
      color: #3c1e1e;
      font-weight: bold;
    }

    .btn-kakao:hover {
      box-shadow: 0 4px 12px rgba(254, 229, 0, 0.4);
    }

    .result-box {
      margin-top: 1rem;
      padding: 1rem;
      border-radius: 8px;
      font-family: 'Courier New', monospace;
      font-size: 0.85rem;
      line-height: 1.4;
      max-height: 300px;
      overflow-y: auto;
      display: none;
    }

    .result-success {
      background: #d4edda;
      border: 1px solid #c3e6cb;
      color: #155724;
    }

    .result-error {
      background: #f8d7da;
      border: 1px solid #f5c6cb;
      color: #721c24;
    }

    .result-info {
      background: #d1ecf1;
      border: 1px solid #bee5eb;
      color: #0c5460;
    }

    .status {
      display: inline-block;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      font-size: 0.8rem;
      font-weight: bold;
      margin-left: 0.5rem;
    }

    .status-connected {
      background: #d4edda;
      color: #155724;
    }

    .status-disconnected {
      background: #f8d7da;
      color: #721c24;
    }

    .token-display {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 6px;
      padding: 0.5rem;
      margin: 0.5rem 0;
      font-family: 'Courier New', monospace;
      font-size: 0.8rem;
      word-break: break-all;
    }

    .api-test-buttons {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.5rem;
      margin-top: 1rem;
    }

    .step-indicator {
      display: flex;
      align-items: center;
      margin-bottom: 1rem;
    }

    .step-number {
      background: #667eea;
      color: white;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.8rem;
      font-weight: bold;
      margin-right: 0.5rem;
    }
  </style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>🧪 카카오 로그인 테스트</h1>
    <p>ClimbX 백엔드 API 개발용 테스트 도구</p>
  </div>

  <!-- 1단계: 연결 테스트 -->
  <div class="section">
    <div class="step-indicator">
      <div class="step-number">1</div>
      <h3>백엔드 서버 연결</h3>
    </div>

    <p style="margin-bottom: 1rem; color: #666; font-size: 0.9rem;">
      백엔드 서버와의 연결을 확인합니다.
    </p>

    <button class="btn btn-secondary" onclick="testConnection()">연결 테스트</button>
    <span class="status status-disconnected" id="configStatus">미연결</span>
  </div>

  <!-- 2단계: 카카오 인증 -->
  <div class="section">
    <div class="step-indicator">
      <div class="step-number">2</div>
      <h3>카카오 인증</h3>
    </div>

    <p style="margin-bottom: 1rem; color: #666; font-size: 0.9rem;">
      카카오 로그인을 진행하여 인가 코드를 받아옵니다. (환경변수에 설정된 KAKAO_REST_API_KEY 사용)
    </p>

    <button class="btn btn-kakao" onclick="startKakaoLogin()">
      🔑 카카오 로그인 시작
    </button>
  </div>

  <!-- 3단계: 인가 코드 처리 -->
  <div class="section">
    <div class="step-indicator">
      <div class="step-number">3</div>
      <h3>인가 코드 처리</h3>
    </div>

    <div class="form-group">
      <label for="authCode">Authorization Code</label>
      <input id="authCode" placeholder="카카오에서 받은 인가 코드" type="text">
    </div>

    <button class="btn btn-secondary" onclick="extractCodeFromUrl()">
      URL에서 자동 추출
    </button>
    <button class="btn" onclick="exchangeToken()">
      토큰 교환 요청
    </button>
  </div>

  <!-- 4단계: API 테스트 -->
  <div class="section">
    <div class="step-indicator">
      <div class="step-number">4</div>
      <h3>API 테스트</h3>
    </div>

    <div id="tokenInfo" style="display: none;">
      <p><strong>발급된 토큰:</strong></p>
      <div class="token-display" id="tokenDisplay"></div>
    </div>

    <div class="api-test-buttons">
      <button class="btn" onclick="testUserInfo()">
        👤 사용자 정보 조회
      </button>
      <button class="btn" onclick="testRefreshToken()">
        🔄 토큰 갱신
      </button>
    </div>
  </div>

  <!-- 결과 표시 -->
  <div id="resultContainer">
    <div class="result-box" id="resultBox"></div>
  </div>
</div>

<script>
  // 전역 변수
  let config = {
    serverUrl: window.location.origin
  };
  let tokens = {};

  // 페이지 로드 시 초기화
  window.onload = function () {
    loadSavedConfig();
    checkUrlForCode();
  };

  // 설정 저장/복원
  function saveConfig() {
    config.serverUrl = document.getElementById('serverUrl').value.trim();

    if (!config.serverUrl) {
      showResult('❌ 백엔드 서버 URL을 입력해주세요', 'error');
      return;
    }

    localStorage.setItem('kakaoTestConfig', JSON.stringify(config));
    updateConfigStatus(true);
    showResult('✅ 설정이 저장되었습니다', 'success');
  }

  function loadSavedConfig() {
    const savedConfig = localStorage.getItem('kakaoTestConfig');
    if (savedConfig) {
      config = JSON.parse(savedConfig);
      if (document.getElementById('serverUrl')) {
        document.getElementById('serverUrl').value = config.serverUrl;
      }
      updateConfigStatus(true);
    }
  }

  function updateConfigStatus(isConfigured) {
    const statusElement = document.getElementById('configStatus');
    if (isConfigured) {
      statusElement.textContent = '설정완료';
      statusElement.className = 'status status-connected';
    } else {
      statusElement.textContent = '미설정';
      statusElement.className = 'status status-disconnected';
    }
  }

  // 백엔드 연결 테스트
  async function testConnection() {
    if (!config.serverUrl) {
      showResult('❌ 먼저 백엔드 서버 URL을 설정해주세요', 'error');
      return;
    }

    try {
      showResult('🔄 백엔드 서버 연결 테스트 중...', 'info');

      const response = await fetch(`${config.serverUrl}/api/auth/oauth2/kakao/authorize-url`);

      if (response.ok) {
        showResult('✅ 백엔드 서버 연결 성공! 카카오 로그인 준비 완료', 'success');
      } else {
        showResult(`❌ 백엔드 서버 연결 실패 (${response.status})`, 'error');
      }
    } catch (error) {
      showResult(`❌ 백엔드 서버 연결 오류: ${error.message}`, 'error');
    }
  }

  // 카카오 로그인 시작
  async function startKakaoLogin() {
    if (!config.serverUrl) {
      showResult('❌ 먼저 백엔드 서버 URL을 설정해주세요', 'error');
      return;
    }

    try {
      showResult('🔄 카카오 인증 URL을 생성하는 중...', 'info');

      const response = await fetch(`${config.serverUrl}/api/auth/oauth2/kakao/authorize-url`);

      if (response.ok) {
        const result = await response.json();
        const kakaoAuthUrl = result.body?.data || result.data || result;

        if (typeof kakaoAuthUrl !== 'string') {
          showResult(`❌ 잘못된 응답 형태: ${JSON.stringify(result, null, 2)}`, 'error');
          return;
        }

        showResult('🔄 카카오 로그인 페이지로 이동합니다...', 'info');
        setTimeout(() => {
          window.location.href = kakaoAuthUrl;
        }, 1000);
      } else {
        const errorText = await response.text();
        showResult(`❌ 카카오 인증 URL 생성 실패 (${response.status})\n\n${errorText}`, 'error');
      }
    } catch (error) {
      showResult(`❌ 네트워크 오류: ${error.message}`, 'error');
    }
  }

  // URL에서 인가 코드 확인
  function checkUrlForCode() {
    const urlParams = new URLSearchParams(window.location.search);
    const code = urlParams.get('code');
    const error = urlParams.get('error');

    if (error) {
      showResult(`❌ 카카오 로그인 오류: ${error}`, 'error');
      return;
    }

    if (code) {
      document.getElementById('authCode').value = code;
      showResult(`✅ 인가 코드를 URL에서 자동으로 가져왔습니다: ${code.substring(0, 20)}...`, 'success');

      // URL 정리 (코드 파라미터 제거)
      const cleanUrl = window.location.origin + window.location.pathname;
      window.history.replaceState({}, document.title, cleanUrl);
    }
  }

  function extractCodeFromUrl() {
    checkUrlForCode();
  }

  // 토큰 교환
  async function exchangeToken() {
    const authCode = document.getElementById('authCode').value.trim();
    if (!authCode) {
      showResult('❌ 인가 코드를 입력해주세요', 'error');
      return;
    }

    if (!config.serverUrl) {
      showResult('❌ 백엔드 서버 URL을 설정해주세요', 'error');
      return;
    }

    try {
      showResult('🔄 토큰 교환 요청 중...', 'info');

      const response = await fetch(
          `${config.serverUrl}/api/auth/oauth2/kakao/callback?code=${authCode}`, {
            method: 'POST',
          });

      if (response.ok) {
        const apiResponse = await response.json();
        if (apiResponse.data) {
          tokens = apiResponse.data;
          displayTokenInfo();
          showResult(
              `✅ 토큰 교환 성공!\n\n- Token Type: ${tokens.tokenType}\n- Expires In: ${tokens.expiresIn}초\n- Access Token: ${tokens.accessToken.substring(
                  0, 50)}...\n- Refresh Token: ${tokens.refreshToken.substring(0, 50)}...`,
              'success');
        } else {
          showResult(`❌ 토큰 교환 실패: 응답 데이터가 올바르지 않습니다.`, 'error');
        }
      } else {
        const errorText = await response.text();
        showResult(`❌ 토큰 교환 실패 (${response.status})\n\n${errorText}`, 'error');
      }
    } catch (error) {
      showResult(`❌ 네트워크 오류: ${error.message}`, 'error');
    }
  }

  // 토큰 정보 표시
  function displayTokenInfo() {
    const tokenInfoDiv = document.getElementById('tokenInfo');
    const tokenDisplayDiv = document.getElementById('tokenDisplay');

    tokenDisplayDiv.innerHTML = `
      <strong>Access Token:</strong> ${tokens.accessToken.substring(0, 50)}...<br>
      <strong>Refresh Token:</strong> ${tokens.refreshToken.substring(0, 50)}...<br>
      <strong>Token Type:</strong> ${tokens.tokenType}<br>
      <strong>Expires In:</strong> ${tokens.expiresIn}초
    `;

    tokenInfoDiv.style.display = 'block';
  }

  // 사용자 정보 조회 테스트
  async function testUserInfo() {
    if (!tokens.accessToken) {
      showResult('❌ 먼저 토큰을 발급받아주세요', 'error');
      return;
    }

    try {
      showResult('🔄 사용자 정보 조회 중...', 'info');

      const response = await fetch(`${config.serverUrl}/api/auth/me`, {
        headers: {
          'Authorization': `Bearer ${tokens.accessToken}`,
          'Content-Type': 'application/json'
        }
      });

      if (response.ok) {
        const userInfo = await response.json();
        showResult(`✅ 사용자 정보 조회 성공!\n\n${JSON.stringify(userInfo, null, 2)}`, 'success');
      } else {
        const errorText = await response.text();
        showResult(`❌ 사용자 정보 조회 실패 (${response.status})\n\n${errorText}`, 'error');
      }
    } catch (error) {
      showResult(`❌ 네트워크 오류: ${error.message}`, 'error');
    }
  }

  // 토큰 갱신 테스트
  async function testRefreshToken() {
    if (!tokens.refreshToken) {
      showResult('❌ 먼저 토큰을 발급받아주세요', 'error');
      return;
    }

    try {
      showResult('🔄 토큰 갱신 중...', 'info');

      const response = await fetch(`${config.serverUrl}/api/auth/oauth2/refresh`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          refreshToken: tokens.refreshToken
        })
      });

      if (response.ok) {
        const result = await response.json();
        tokens = result.data || result;
        displayTokenInfo();
        showResult(`✅ 토큰 갱신 성공!\n\n- New Access Token: ${tokens.accessToken.substring(0, 50)}...\n- New Refresh Token: ${tokens.refreshToken.substring(0, 50)}...`, 'success');
      } else {
        const errorText = await response.text();
        showResult(`❌ 토큰 갱신 실패 (${response.status})\n\n${errorText}`, 'error');
      }
    } catch (error) {
      showResult(`❌ 네트워크 오류: ${error.message}`, 'error');
    }
  }

  // 결과 표시
  function showResult(message, type) {
    const resultBox = document.getElementById('resultBox');

    // 타입별 클래스 설정
    resultBox.className = `result-box result-${type}`;
    resultBox.textContent = message;
    resultBox.style.display = 'block';

    // 결과 영역으로 부드럽게 스크롤
    resultBox.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
  }
</script>
</body>
</html> 